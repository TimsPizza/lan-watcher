# LAN Watcher 项目计划书

## 📋 项目概述

### 项目定位
LAN Watcher 是一个专注于局域网设备发现与在线状态监控的轻量级工具，旨在：
- 自动发现并跟踪局域网内设备
- 记录设备在线/离线状态变化
- 提供直观的数据可视化界面
- 分析设备上线趋势和使用模式

### 技术架构
- **后端**: FastAPI + 文件存储系统
- **前端**: React 应用
- **扫描引擎**: nmap + 传统网络工具
- **数据存储**: JSON 文件（替代原SQLite数据库）

## ✅ 已完成工作

### 1. 存储系统重构 (已完成)
- **迁移目标**: 从SQLite数据库迁移到JSON文件存储
- **完成内容**:
  - 实现了完整的文件存储系统 (`storage/file_storage.py`)
  - 创建了线程安全的数据操作接口
  - 迁移了所有数据模型：设备、扫描记录、扫描会话、应用设置、图表配置
  - 设备ID从数字改为UUID格式
  - 实现了自动数据清理功能

### 2. 服务层重构 (已完成)
- **迁移内容**:
  - 更新 `service/services.py` 移除所有SQLAlchemy依赖
  - 保持原有API接口不变
  - 集成文件存储操作
  - 优化数据访问性能

### 3. API层更新 (已完成)
- **更新内容**:
  - 移除数据库依赖注入 (`Depends(get_db)`)
  - 更新设备ID参数类型（int → str）
  - 保持API路径和响应格式兼容性
  - 集成新的存储初始化

### 4. 扫描器优化 (已完成)
- **问题修复**:
  - 解决了扫描出整个子网（256个设备）的误报问题
  - 优化nmap参数：移除多余的TCP ping方法，降低扫描速率
  - 实现ARP表信息补充，改善MAC地址和厂商信息获取
  - 当前扫描结果：准确识别实际在线设备（7个 vs 原来的256个）

### 5. 配置系统实现 (已完成)
- **目标**: 实现完整的用户可定制扫描参数系统
- **核心组件**:
  - **配置模型** (`models/scan_config.py`): 
    - 15+ 可配置参数覆盖网络设置、性能参数、功能开关
    - 4种预设模式：Fast(300pps)、Balanced(100pps)、Thorough(50pps)、Stealth(10pps)
    - 完整的参数验证和默认值处理
  - **存储集成** (`storage/file_storage.py`):
    - 配置持久化到 `scan_config.json`
    - 线程安全的配置读写操作
    - 配置验证和错误处理机制
  - **扫描器集成** (`scanner/scanner.py`):
    - 根据配置动态生成nmap参数
    - IP排除逻辑实现
    - 可配置的主机名解析和厂商信息获取
  - **服务层** (`service/services.py`):
    - `ScanConfigService` 完整配置管理API
    - 配置验证和网络测试功能
    - 预设模式管理和切换
  - **HTTP API** (`main.py`):
    - REST API端点：配置管理、预设加载、验证测试
    - Pydantic模型确保数据验证
    - 实时配置更新支持
  - **命令行工具** (`config_manager.py`):
    - 完整CLI管理界面
    - 配置显示、预设切换、参数设置
    - 导入/导出配置功能
  - **文档和测试**:
    - 详细的使用指南 (`CONFIG_GUIDE.md`)
    - 综合测试套件 (`test_config.py`)
    - API端点功能验证
- **技术特性**:
  - 配置实时生效，无需重启服务
  - 线程安全的配置操作
  - 完整的错误处理和回退机制
  - 支持配置导入导出和备份

### 6. 支持工具 (已完成)
- 创建了数据库到文件存储的迁移工具
- 编写了全面的测试套件
- 生成了详细的迁移文档和配置指南

## 🎯 下一步计划

### Phase 2: 前端配置界面 (高优先级)

#### 2.1 设置页面开发
- 扫描参数配置界面
- 网络设置（子网配置、排除IP）
- 性能调优选项
- 预设模式选择器

#### 2.2 实时反馈
- 配置更改的即时预览
- 扫描性能指标显示
- 网络连通性测试工具

#### 2.3 用户体验优化
- 配置项分组和向导式设置
- 性能建议和最佳实践提示
- 配置导入导出界面

### Phase 3: 高级监控功能 (中优先级)

#### 3.1 设备状态智能分析
- **离线阈值配置**: 设备多久未响应标记为离线
- **状态变化敏感度**: 避免网络抖动造成的状态频繁切换
- **设备分组管理**: 按设备类型、位置等分组

#### 3.2 历史数据优化
- **数据保留策略**: 可配置的历史数据保留期
- **自动清理机制**: 定期清理过期数据
- **数据压缩**: 长期数据的压缩存储

### Phase 4: 用户体验提升 (低优先级)

#### 4.1 通知系统
- 设备上线/离线通知
- 新设备发现提醒
- 扫描异常报警

#### 4.2 高级功能
- 网络拓扑可视化
- 设备详细信息页面
- 扫描历史数据分析

#### 4.3 性能监控
- 扫描耗时统计
- 网络负载监控
- 系统资源使用情况

## 🎯 近期里程碑

### ✅ 已完成里程碑
- ✅ 实现 `ScanConfig` 数据类和验证逻辑
- ✅ 修改 `NetworkScanner` 支持配置参数
- ✅ 添加配置管理API端点
- ✅ 实现预设配置模式
- ✅ 添加网络配置验证和测试
- ✅ 完善配置变更的实时生效
- ✅ 创建命令行管理工具
- ✅ 编写详细的配置文档

### 🔄 当前进行中
- [ ] 开发前端设置页面基础框架
- [ ] 实现核心配置项的UI组件
- [ ] 集成配置保存和加载功能

### 📅 下周计划
- [ ] 实现预设模式选择器界面
- [ ] 添加配置验证的前端反馈
- [ ] 创建网络测试工具界面

## 🔧 技术风险与缓解

### 风险1: 配置复杂性
- **风险**: 过多配置选项可能困惑用户
- **缓解**: ✅ 已实现4种预设模式，复杂选项隐藏在高级设置中

### 风险2: 网络环境兼容性
- **风险**: 不同网络环境下扫描参数效果差异
- **缓解**: ✅ 已实现网络配置测试和自适应参数建议

### 风险3: 性能影响
- **风险**: 配置不当可能影响扫描性能
- **缓解**: ✅ 已添加参数验证和性能优化的预设模式

## 📊 成功指标

1. **功能完整性**: ✅ 所有核心配置参数已可通过API调整，待前端UI完成
2. **用户友好性**: 🔄 目标：新用户可在5分钟内完成基础配置（CLI已实现，UI开发中）
3. **性能稳定性**: ✅ 配置变更后扫描准确率保持>95%，已通过测试验证
4. **系统可靠性**: ✅ 配置错误能够优雅降级到默认设置

## 📝 项目当前状态

### 文件结构概览
```
lan-watcher/
├── backend/
│   ├── storage/
│   │   ├── file_storage.py      # 文件存储系统（含配置管理）
│   │   └── data/               # JSON数据文件目录
│   │       └── scan_config.json # 扫描配置文件 ⭐
│   ├── scanner/
│   │   └── scanner.py          # 网络扫描器（配置集成）⭐
│   ├── service/
│   │   └── services.py         # 业务逻辑层（配置服务）⭐
│   ├── models/
│   │   ├── scan_config.py      # 配置模型和预设 ⭐
│   │   └── oui_parser.py       # OUI厂商数据
│   ├── main.py                 # FastAPI应用（配置API）⭐
│   ├── config_manager.py       # 命令行配置工具 ⭐
│   ├── test_config.py         # 配置系统测试 ⭐
│   ├── CONFIG_GUIDE.md        # 配置使用指南 ⭐
│   └── migrate_to_file_storage.py # 迁移工具
└── frontend/                   # React前端应用
```

### 技术债务
- ~~前端可能需要适配设备ID格式变更（UUID）~~ ✅ **API已兼容**
- ~~需要验证前后端API兼容性~~ ✅ **已验证**
- ~~配置系统尚未实现~~ ✅ **已完成**
- **新增**: 前端配置界面需要开发以匹配后端功能

### 当前系统能力
- ✅ **配置管理**: 完整的15+参数配置系统
- ✅ **预设模式**: 4种优化场景的预设配置
- ✅ **API接口**: REST API支持配置的增删改查
- ✅ **命令行工具**: 完整的CLI管理界面
- ✅ **实时更新**: 配置变更即时生效
- ✅ **参数验证**: 全面的配置验证和错误处理
- ✅ **网络测试**: 配置有效性验证功能
- ✅ **导入导出**: 配置备份和恢复机制
- 🔄 **Web界面**: 配置管理的图形界面（开发中）

这个项目现已具备完整的后端配置系统，为用户提供了强大而灵活的网络扫描定制能力。下一步重点是开发对应的前端界面，让用户能够通过图形界面轻松管理这些配置。 